name: release-packages

on:
  # Manually trigger the release chain starting from a specific package
  workflow_dispatch:
    inputs:
      package:
        description: "ğŸš€ Start AUTOMATIC release chain from this package (will auto-release this and all packages after it)"
        required: true
        type: choice
        options:
          - logger
          - fs
          - builder
          - server
          - project
          - cli
        default: logger

permissions:
  contents: write
  pull-requests: write
  actions: write

jobs:
  start-release-chain:
    runs-on: ubuntu-24.04
    outputs:
      started_package: ${{ steps.start_chain.outputs.started_package }}
      chain_length: ${{ steps.start_chain.outputs.chain_length }}
    steps:
      - uses: actions/checkout@v5
      
      - name: Start release chain
        id: start_chain
        env:
          GH_TOKEN: ${{ secrets.RELEASE_PLEASE_TOKEN }}
        run: |
          ALL_PACKAGES=("logger" "fs" "builder" "server" "project" "cli")
          SELECTED_PKG="${{ github.event.inputs.package }}"
          
          echo "ğŸš€ Starting release chain from package: $SELECTED_PKG"
          
          # Find starting position in dependency order
          START_IDX=-1
          for i in "${!ALL_PACKAGES[@]}"; do
            [[ "${ALL_PACKAGES[$i]}" == "$SELECTED_PKG" ]] && START_IDX=$i && break
          done
          
          [[ $START_IDX -eq -1 ]] && echo "âŒ Package not found" && exit 1
          
          # Show what will be released
          CHAIN_LENGTH=$((${#ALL_PACKAGES[@]} - START_IDX))
          echo "ğŸ“¦ Will release $CHAIN_LENGTH packages: ${ALL_PACKAGES[@]:$START_IDX}"
          
          # Find and merge the PR
          PR_NUMBER=$(gh pr list --state open --json number,title | jq -r '.[] | select(.title | startswith("release: @ui5/ '$SELECTED_PKG' v")) | .number' | head -n1)
          
          if [[ -n "$PR_NUMBER" ]]; then
            echo "âœ… Found PR #$PR_NUMBER, merging..."
            gh pr merge $PR_NUMBER --squash --admin
            echo "started_package=$SELECTED_PKG" >> $GITHUB_OUTPUT
            echo "chain_length=$CHAIN_LENGTH" >> $GITHUB_OUTPUT
          else
            echo "âŒ No release PR found for $SELECTED_PKG"
            exit 1
          fi
      
      - name: Chain initiation summary
        run: |
          echo "ğŸ‰ Release Chain Initiated!"
          echo "================================"
          echo "ï¿½ Started from: ${{ steps.start_chain.outputs.started_package }}"
          echo "ï¿½ Chain length: ${{ steps.start_chain.outputs.chain_length }} packages"
          echo "ğŸ”— Flow: release-please.yml â†’ auto-release-chain.yml â†’ (repeats automatically)"
          echo ""
          echo "â„¹ï¸ The chain will now continue automatically:"
          echo "  1. release-please.yml publishes ${{ steps.start_chain.outputs.started_package }} to NPM"
          echo "  2. auto-release-chain.yml detects completion and merges next package PR"
          echo "  3. Repeats until all packages in chain are released"
          echo ""
          echo "âœ… You can monitor progress in the Actions tab"
