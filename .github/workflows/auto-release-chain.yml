name: auto-release-chain

on:
  workflow_run:
    workflows: ["release-please"]
    types: [completed]
    branches: [main]

permissions:
  contents: write
  pull-requests: write

jobs:
  continue-chain:
    runs-on: ubuntu-24.04
    if: github.event.workflow_run.conclusion == 'success'
    steps:
      - uses: actions/checkout@v5
      
      - name: Find next package
        id: next-pkg
        run: |
          ALL_PACKAGES=("logger" "fs" "builder" "server" "project" "cli")
          
          # Find what was just released
          RELEASED_PKG=""
          if git log -1 --pretty=format:"%s" | grep -q "^release: @ui5/"; then
            RELEASED_PKG=$(git log -1 --pretty=format:"%s" | sed -n 's/^release: @ui5\/ \([a-z-]*\) v.*/\1/p')
            echo "ðŸ“¦ Detected release: $RELEASED_PKG"
          else
            echo "â„¹ï¸ No release detected"
            exit 0
          fi
          
          # Find next package
          for i in "${!ALL_PACKAGES[@]}"; do
            if [[ "${ALL_PACKAGES[$i]}" == "$RELEASED_PKG" ]] && [[ $((i+1)) -lt ${#ALL_PACKAGES[@]} ]]; then
              NEXT_PKG="${ALL_PACKAGES[$((i+1))]}"
              echo "ðŸŽ¯ Next package: $NEXT_PKG"
              echo "next_package=$NEXT_PKG" >> $GITHUB_OUTPUT
              echo "has_next=true" >> $GITHUB_OUTPUT
              exit 0
            fi
          done
          
          echo "ï¿½ Chain complete"
          echo "has_next=false" >> $GITHUB_OUTPUT
      
      - name: Merge next PR
        if: steps.next-pkg.outputs.has_next == 'true'
        uses: ./.github/actions/merge-release-pr
        with:
          package: ${{ steps.next-pkg.outputs.next_package }}
          github-token: ${{ secrets.RELEASE_PLEASE_TOKEN }}