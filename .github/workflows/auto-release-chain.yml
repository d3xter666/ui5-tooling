name: auto-release-chain

on:
  workflow_run:
    workflows: ["release-please"]
    types: [completed]
    branches: [main]

permissions:
  contents: write
  pull-requests: write

jobs:
  continue-chain:
    runs-on: ubuntu-24.04
    if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch'
    
    # Job-level outputs for reuse across steps
    outputs:
      all_packages: ${{ steps.setup.outputs.all_packages }}
      released_package: ${{ steps.detect-release.outputs.released_package }}
      has_release: ${{ steps.detect-release.outputs.has_release }}
      next_package: ${{ steps.find-next.outputs.next_package }}
      has_next: ${{ steps.find-next.outputs.has_next }}
      has_changes: ${{ steps.update-deps.outputs.has_changes }}
      is_chain_mode: ${{ steps.detect-release.outputs.is_chain_mode }}
    
    # Environment variables for reuse
    env:
      GH_TOKEN: ${{ secrets.RELEASE_PLEASE_TOKEN }}
      NODE_VERSION: 24.x
      REGISTRY_URL: https://registry.npmjs.org/
      GIT_USER_NAME: "github-actions[bot]"
      GIT_USER_EMAIL: "github-actions[bot]@users.noreply.github.com"
      
    steps:
      - uses: actions/checkout@v5
        with:
          token: ${{ secrets.RELEASE_PLEASE_TOKEN }}
          fetch-depth: 0

      - name: Detect released package and mode
        id: detect-release
        run: |
          # Detect released package from commit
          if git log -1 --pretty=format:"%s" | grep -q "^release: @ui5/"; then
            RELEASED_PKG=$(git log -1 --pretty=format:"%s" | sed -n 's/^release: @ui5\/ \([a-z-]*\) v.*/\1/p')
            echo "📦 Detected release: $RELEASED_PKG"
            echo "released_package=$RELEASED_PKG" >> $GITHUB_OUTPUT
            echo "has_release=true" >> $GITHUB_OUTPUT
          else
            echo "ℹ️ No release detected"
            echo "has_release=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check if chain mode is active
          CHAIN_MODE=$(gh variable get CHAIN_MODE 2>/dev/null || echo "false")
          echo "is_chain_mode=$CHAIN_MODE" >> $GITHUB_OUTPUT
          echo "🔗 Chain mode: $CHAIN_MODE"
        env:
          GH_TOKEN: ${{ secrets.RELEASE_PLEASE_TOKEN }}

      - name: Setup Node.js
        if: steps.detect-release.outputs.has_release == 'true'
        uses: actions/setup-node@v5
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: ${{ env.REGISTRY_URL }}

      - name: Setup git and packages array
        if: steps.detect-release.outputs.has_release == 'true'
        id: setup
        run: |
          git config user.name "${{ env.GIT_USER_NAME }}"
          git config user.email "${{ env.GIT_USER_EMAIL }}"
          
          # Define packages array for reuse
          ALL_PACKAGES="logger fs builder server project cli"
          echo "all_packages=$ALL_PACKAGES" >> $GITHUB_OUTPUT
          echo "📦 Package chain: $ALL_PACKAGES"

      - name: Find next package in chain
        id: find-next
        if: steps.detect-release.outputs.has_release == 'true'
        run: |
          ALL_PACKAGES_ARRAY=(${{ steps.setup.outputs.all_packages }})
          RELEASED_PKG="${{ steps.detect-release.outputs.released_package }}"
          IS_CHAIN_MODE="${{ steps.detect-release.outputs.is_chain_mode }}"
          
          echo "🔍 Looking for next package after: $RELEASED_PKG (Chain mode: $IS_CHAIN_MODE)"

          if [[ "$IS_CHAIN_MODE" == "true" ]]; then
            # CHAIN MODE: Find next package in sequence
            NEXT_PKG=""
            for i in "${!ALL_PACKAGES_ARRAY[@]}"; do
              if [[ "${ALL_PACKAGES_ARRAY[$i]}" == "$RELEASED_PKG" ]] && [[ $((i+1)) -lt ${#ALL_PACKAGES_ARRAY[@]} ]]; then
                NEXT_PKG="${ALL_PACKAGES_ARRAY[$((i+1))]}"
                break
              fi
            done
            
            # If no next package and not CLI, fallback to CLI
            if [[ -z "$NEXT_PKG" && "$RELEASED_PKG" != "cli" ]]; then
              NEXT_PKG="cli"
            fi
            
            # If we just processed CLI, clear the chain mode
            if [[ "$RELEASED_PKG" == "cli" ]]; then
              echo "🎉 Chain complete - clearing chain mode"
              gh variable delete CHAIN_MODE 2>/dev/null || true
              gh variable delete CHAIN_START_PACKAGE 2>/dev/null || true
            fi
          else
            # MANUAL MODE: Only release CLI if not CLI itself
            if [[ "$RELEASED_PKG" != "cli" ]]; then
              NEXT_PKG="cli"
            fi
          fi

          # Set outputs
          if [[ -n "$NEXT_PKG" ]]; then
            echo "🎯 Found next package: $NEXT_PKG"
            echo "next_package=$NEXT_PKG" >> $GITHUB_OUTPUT
            echo "has_next=true" >> $GITHUB_OUTPUT
          else
            echo "🏁 No next package found"
            echo "has_next=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.RELEASE_PLEASE_TOKEN }}

      - name: Update dependencies in next package
        id: update-deps
        if: steps.find-next.outputs.has_next == 'true'
        run: |
          NEXT_PKG="${{ steps.find-next.outputs.next_package }}"
          RELEASED_PKG="${{ steps.detect-release.outputs.released_package }}"
          
          # Install npm-check-updates
          npm install -g npm-check-updates
          
          echo "🔄 Processing package: $NEXT_PKG"
          cd "packages/$NEXT_PKG"
          
          echo "📦 Updating @ui5/* dependencies to latest minor/patch versions (respecting major)"
          
          # Update @ui5/* packages respecting major version boundaries
          ncu -u --filter "@ui5/*" --target minor --dep dev,prod,peer,optional
          
          # Check if there were actual changes
          if git diff --quiet package.json; then
            echo "ℹ️ No dependency updates needed for $NEXT_PKG"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "✅ Dependencies updated for $NEXT_PKG"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit dependency updates
        if: steps.update-deps.outputs.has_changes == 'true'
        run: |
          NEXT_PKG="${{ steps.find-next.outputs.next_package }}"

          git add "packages/$NEXT_PKG/"
          git commit -m "deps($NEXT_PKG): Update @ui5 dependencies to latest versions"
          git push origin main

          echo "✅ Committed dependency updates for $NEXT_PKG"

      - name: Trigger release-please for updated package
        if: steps.update-deps.outputs.has_changes == 'true'
        uses: googleapis/release-please-action@v4
        id: trigger-release
        with:
          token: ${{ secrets.RELEASE_PLEASE_TOKEN }}

      - name: Merge release PR
        if: steps.update-deps.outputs.has_changes == 'true'
        id: merge-pr
        uses: ./.github/actions/merge-release-pr
        with:
          package: ${{ steps.find-next.outputs.next_package }}
          github-token: ${{ secrets.RELEASE_PLEASE_TOKEN }}
