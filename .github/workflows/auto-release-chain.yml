name: auto-release-chain

on:
  workflow_run:
    workflows: ["release-please"]
    types: [completed]
    branches: [main]
  workflow_dispatch:
    inputs:
      chain_mode:
        description: 'Release mode'
        required: true
        type: boolean
        default: true
      start_package:
        description: '🚀 Start chain from this package (chain mode only)'
        required: true
        type: choice
        default: logger
        options:
          - logger
          - fs
          - builder
          - server
          - project
          - cli

permissions:
  contents: write
  pull-requests: write

jobs:
  continue-chain:
    runs-on: ubuntu-24.04
    if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch'
    
    # Job-level outputs for reuse across steps
    outputs:
      all_packages: ${{ steps.setup.outputs.all_packages }}
      released_package: ${{ steps.detect-release.outputs.released_package }}
      has_release: ${{ steps.detect-release.outputs.has_release }}
      next_package: ${{ steps.find-next.outputs.next_package }}
      has_next: ${{ steps.find-next.outputs.has_next }}
      has_changes: ${{ steps.update-deps.outputs.has_changes }}
      is_chain_mode: ${{ steps.detect-release.outputs.is_chain_mode }}
    
    # Environment variables for reuse
    env:
      GH_TOKEN: ${{ secrets.RELEASE_PLEASE_TOKEN }}
      NODE_VERSION: 24.x
      REGISTRY_URL: https://registry.npmjs.org/
      GIT_USER_NAME: "github-actions[bot]"
      GIT_USER_EMAIL: "github-actions[bot]@users.noreply.github.com"
      
    steps:
      - uses: actions/checkout@v5
        with:
          token: ${{ secrets.RELEASE_PLEASE_TOKEN }}
          fetch-depth: 0

      - name: Detect released package and mode
        id: detect-release
        run: |
          # Determine chain mode and released package
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            IS_CHAIN_MODE="${{ github.event.inputs.chain_mode }}"
            RELEASED_PKG="${{ github.event.inputs.start_package }}"
          else
            # Triggered by workflow_run - detect from commit
            IS_CHAIN_MODE="false"  # Manual mode for workflow_run
            if git log -1 --pretty=format:"%s" | grep -q "^release: @ui5/"; then
              RELEASED_PKG=$(git log -1 --pretty=format:"%s" | sed -n 's/^release: @ui5\/ \([a-z-]*\) v.*/\1/p')
              echo "👤 Manual mode - detected release: $RELEASED_PKG"
            else
              echo "ℹ️ No release detected"
              echo "has_release=false" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi

          # Set output variables
          echo "released_package=$RELEASED_PKG" >> $GITHUB_OUTPUT
          echo "has_release=true" >> $GITHUB_OUTPUT
          echo "is_chain_mode=$IS_CHAIN_MODE" >> $GITHUB_OUTPUT
          echo "🔗 Chain mode: $IS_CHAIN_MODE"

      - name: Setup Node.js
        if: steps.detect-release.outputs.has_release == 'true'
        uses: actions/setup-node@v5
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: ${{ env.REGISTRY_URL }}

      - name: Setup git and packages array
        if: steps.detect-release.outputs.has_release == 'true'
        id: setup
        run: |
          git config user.name "${{ env.GIT_USER_NAME }}"
          git config user.email "${{ env.GIT_USER_EMAIL }}"
          
          # Define packages array for reuse
          ALL_PACKAGES="logger fs builder server project cli"
          echo "all_packages=$ALL_PACKAGES" >> $GITHUB_OUTPUT
          echo "📦 Package chain: $ALL_PACKAGES"

      - name: Find next package in chain
        id: find-next
        if: steps.detect-release.outputs.has_release == 'true'
        run: |
          ALL_PACKAGES_ARRAY=(${{ steps.setup.outputs.all_packages }})
          RELEASED_PKG="${{ steps.detect-release.outputs.released_package }}"
          
          echo "🔍 Looking for next package after: $RELEASED_PKG"

          # Find the immediate next package in chain
          NEXT_PKG=""
          for i in "${!ALL_PACKAGES_ARRAY[@]}"; do
            if [[ "${ALL_PACKAGES_ARRAY[$i]}" == "$RELEASED_PKG" ]] && [[ $((i+1)) -lt ${#ALL_PACKAGES_ARRAY[@]} ]]; then
              NEXT_PKG="${ALL_PACKAGES_ARRAY[$((i+1))]}"
              break
            fi
          done

          if [[ "$IS_CHAIN_MODE" != "true" && "$RELEASED_PKG" != "cli" ]]; then
              echo "🎯 End of chain reached, falling back to CLI"
              echo "next_package=cli" >> $GITHUB_OUTPUT
              echo "has_next=true" >> $GITHUB_OUTPUT
          else
            if [[ -n "$NEXT_PKG" ]]; then
              echo "🎯 Found next package: $NEXT_PKG"
              echo "next_package=$NEXT_PKG" >> $GITHUB_OUTPUT
              echo "has_next=true" >> $GITHUB_OUTPUT
            else
              echo "🏁 No next package found (end of chain)"
              echo "has_next=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Update dependencies in next package
        id: update-deps
        if: steps.find-next.outputs.has_next == 'true'
        run: |
          NEXT_PKG="${{ steps.find-next.outputs.next_package }}"
          RELEASED_PKG="${{ steps.detect-release.outputs.released_package }}"
          
          # Install npm-check-updates
          npm install -g npm-check-updates
          
          echo "🔄 Processing package: $NEXT_PKG"
          cd "packages/$NEXT_PKG"
          
          echo "📦 Updating dependency for recently published package: @ui5/$RELEASED_PKG"
          
          # Only update the specific package that was just released/published
          if npm view "@ui5/$RELEASED_PKG" version > /dev/null 2>&1; then
            LATEST_VERSION=$(npm view "@ui5/$RELEASED_PKG" version)
            echo "📦 Latest NPM version for @ui5/$RELEASED_PKG: $LATEST_VERSION"
            
            # Update only the specific released package dependency
            if grep -q "\"@ui5/$RELEASED_PKG\"" package.json; then
              echo "📝 Updating @ui5/$RELEASED_PKG to ^$LATEST_VERSION"
              npm pkg set "dependencies.@ui5/$RELEASED_PKG=^$LATEST_VERSION"
            else
              echo "ℹ️ Package $NEXT_PKG doesn't depend on @ui5/$RELEASED_PKG"
            fi
          else
            echo "⚠️ @ui5/$RELEASED_PKG not found on NPM yet"
          fi
          
          # Check if there were actual changes
          if git diff --quiet package.json; then
            echo "ℹ️ No dependency updates needed for $NEXT_PKG"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "✅ Dependencies updated for $NEXT_PKG"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit dependency updates
        if: steps.update-deps.outputs.has_changes == 'true'
        run: |
          NEXT_PKG="${{ steps.find-next.outputs.next_package }}"

          git add "packages/$NEXT_PKG/"
          git commit -m "deps($NEXT_PKG): Update @ui5 dependencies to latest versions"
          git push origin main

          echo "✅ Committed dependency updates for $NEXT_PKG"

      - name: Trigger release-please for updated package
        if: steps.update-deps.outputs.has_changes == 'true'
        uses: googleapis/release-please-action@v4
        id: trigger-release
        with:
          token: ${{ secrets.RELEASE_PLEASE_TOKEN }}

      - name: Merge release PR
        if: steps.update-deps.outputs.has_changes == 'true'
        id: merge-pr
        uses: ./.github/actions/merge-release-pr
        with:
          package: ${{ steps.find-next.outputs.next_package }}
          github-token: ${{ secrets.RELEASE_PLEASE_TOKEN }}
